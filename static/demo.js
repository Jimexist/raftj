// Generated by CoffeeScript 1.9.0
(function() {
  angular.module('project', []).controller('ServerStatusController', [
    '$scope', '$interval', function($scope, $interval) {
      var stop;
      $scope.servers = [];
      $scope.init = function() {
        return $.get("/api/servers", function(data) {
          var address;
          $scope.servers = (function() {
            var _i, _len, _ref, _results;
            _ref = JSON.parse(data);
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              address = _ref[_i];
              _results.push({
                address: address,
                ping: '',
                pingDelay: -1,
                leader: false,
                online: false,
                leaderID: ''
              });
            }
            return _results;
          })();
          return $scope.$apply();
        });
      };
      $scope.restart = function(address) {
        return $.ajax({
          url: encodeURI("/api/servers/" + address + "/restart"),
          method: 'POST',
          success: function(data) {
            return alert(data);
          },
          error: function(err) {
            return alert(err);
          }
        });
      };
      $scope.start = function(address) {
        return $.ajax({
          url: encodeURI("/api/servers/" + address + "/start"),
          method: 'POST',
          success: function(data) {
            return alert(data);
          },
          error: function(err) {
            return alert(err);
          }
        });
      };
      $scope.stop = function(address) {
        return $.ajax({
          url: encodeURI("/api/servers/" + address + "/stop"),
          method: 'POST',
          success: function(data) {
            return alert(data);
          },
          error: function(err) {
            return alert(err);
          }
        });
      };
      $scope.updateStatus = function() {
        var i, _i, _ref, _results;
        _results = [];
        for (i = _i = 0, _ref = $scope.servers.length - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
          _results.push((function(i) {
            var address;
            address = $scope.servers[i].address;
            return $.ajax({
              url: encodeURI("/api/servers/" + address + "/status"),
              success: function(data) {
                data = JSON.parse(data);
                $scope.servers[i].online = true;
                $scope.servers[i].leader = data.status;
                $scope.servers[i].leaderID = data.leaderID;
                $scope.servers[i].ping = data.msg || (new Date()).toTimeString();
                return $scope.servers[i].pingTime = Math.round(Number(data.time) * 1000 * 1000) / 1000.0;
              },
              error: function(err) {
                $scope.servers[i].online = false;
                return $scope.servers[i].leader = void 0;
              }
            });
          })(i));
        }
        return _results;
      };
      stop = void 0;
      $scope.poll = function() {
        console.log('start polling');
        if (angular.isDefined(stop)) {
          console.log('stop already defined, return');
          return;
        }
        return stop = $interval(function() {
          return $scope.updateStatus();
        }, 1000);
      };
      $scope.stopPolling = function() {
        if (angular.isDefined(stop)) {
          $interval.cancel(stop);
          return stop = void 0;
        }
      };
      $scope.$on('destroy', function() {
        return $scope.stopPolling();
      });
      $scope.init();
      return $scope.poll();
    }
  ]).controller('ClientController', [
    '$scope', function() {
      var client;
      return client = this;
    }
  ]);

}).call(this);
